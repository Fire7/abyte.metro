!function(a){!function(a,b,c){function d(a,b){return typeof a===b}function e(){var a,b,c,e,f,g,j;for(var l in i)if(i.hasOwnProperty(l)){if(a=[],b=i[l],b.name&&(a.push(b.name.toLowerCase()),b.options&&b.options.aliases&&b.options.aliases.length))for(c=0;c<b.options.aliases.length;c++)a.push(b.options.aliases[c].toLowerCase());for(e=d(b.fn,"function")?b.fn():b.fn,f=0;f<a.length;f++)g=a[f],j=g.split("."),1===j.length?k[j[0]]=e:(!k[j[0]]||k[j[0]]instanceof Boolean||(k[j[0]]=new Boolean(k[j[0]])),k[j[0]][j[1]]=e),h.push((e?"":"no-")+j.join("-"))}}function f(a){var b=m.className,c=k._config.classPrefix||"";if(n&&(b=b.baseVal),k._config.enableJSClass){var d=new RegExp("(^|\\s)"+c+"no-js(\\s|$)");b=b.replace(d,"$1"+c+"js$2")}k._config.enableClasses&&(b+=" "+c+a.join(" "+c),n?m.className.baseVal=b:m.className=b)}function g(a,b){if("object"==typeof a)for(var c in a)l(a,c)&&g(c,a[c]);else{a=a.toLowerCase();var d=a.split("."),e=k[d[0]];if(2==d.length&&(e=e[d[1]]),"undefined"!=typeof e)return k;b="function"==typeof b?b():b,1==d.length?k[d[0]]=b:(!k[d[0]]||k[d[0]]instanceof Boolean||(k[d[0]]=new Boolean(k[d[0]])),k[d[0]][d[1]]=b),f([(b&&0!=b?"":"no-")+d.join("-")]),k._trigger(a,b)}return k}var h=[],i=[],j={_version:"3.3.1",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(a,b){var c=this;setTimeout(function(){b(c[a])},0)},addTest:function(a,b,c){i.push({name:a,fn:b,options:c})},addAsyncTest:function(a){i.push({name:null,fn:a})}},k=function(){};k.prototype=j,k=new k;var l,m=b.documentElement,n="svg"===m.nodeName.toLowerCase();!function(){var a={}.hasOwnProperty;l=d(a,"undefined")||d(a.call,"undefined")?function(a,b){return b in a&&d(a.constructor.prototype[b],"undefined")}:function(b,c){return a.call(b,c)}}(),j._l={},j.on=function(a,b){this._l[a]||(this._l[a]=[]),this._l[a].push(b),k.hasOwnProperty(a)&&setTimeout(function(){k._trigger(a,k[a])},0)},j._trigger=function(a,b){if(this._l[a]){var c=this._l[a];setTimeout(function(){var a,d;for(a=0;a<c.length;a++)(d=c[a])(b)},0),delete this._l[a]}},k._q.push(function(){j.addTest=g}),k.addTest("svgasimg",b.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")),e(),f(h),delete j.addTest,delete j.addAsyncTest;for(var o=0;o<k._q.length;o++)k._q[o]();a.Modernizr=k}(window,document);var b=0,c="2.0.2",d={init:function(d){return this.each(function(){var n,p,f=a(this),g=a.extend({width:1e3,img:"",error_img:"",stations_src:[],stations_info:{},show_info:!1,editable:!0,search_and_input:!0,width:null,value:[],disabled:[],clear_button:!0,delete_message:"",search_message:"",limit:0,className:"",blur:!0,show_submit:!1,submit_param:"",submit_message:"",_edit:!1,_debug:!1},d),i="",j={},k=[],l={},m={},o=[],q=!1,r=b++;g.stations_info=g.stations_info||{},g._debug&&(console.error("jMetro settings:",g),window["jValue"+r]=j,window["$this"+r]=f);var s=(isNaN(parseInt(g.width))?1e3:parseInt(g.width))/1e3;g._edit&&(g.stations_info={});for(var t=g.value.length;t--;)j[g.value[t]]=1;for(var t=g.disabled.length;t--;)m[g.disabled[t]]=1;g.search_and_input&&(i+='<div class="jm_search "><div class="jm_select2"></div></div>'),g.clear_button&&(i+='<div class="jm_clear">'+g.delete_message+"</div>"),g.show_submit&&(i+='<div class="jm_submit__button">'+g.submit_message+"</div>"),i+='<div style="clear:both;"></div><div class="jm_img_block" '+(g.width?'style="width:'+g.width+'"':"")+'><div class="jm_frame"></div><img class="jm_img"',g.width&&(i+=" width="+g.width),g.error_img&&(i+=" onerror=\"this.onerror=null; this.src='"+g.error_img+"'\""),i+=' src="'+(!Modernizr.svgasimg&&g.error_img?g.error_img:g.img)+'"',i+=">",i+='<div class="jm_imgmap">';for(var w,x,y,z,A,B,u=g.stations_src,v=!1,t=0;t<u.length;t++){A=!1,w=u[t],z=g.stations_info[w.id],B={top:Math.round(w.top*s),left:Math.round(w.left*s),width:Math.round(w.width*s),height:Math.round(w.height*s)},x=jQuery("<div/>",{id:"jm_"+r+"_station_"+w.id,class:"jm_station "+g.className+(w.class?" "+w.class:"")+(m[w.id]?" disabled":""),title:z&&z.title||w.name,css:{top:B.top,left:B.left,width:B.width,height:B.height}}),(j[w.id]||g._edit)&&(x.addClass("selected active"),v=!0);for(var D,C=0,y="";C<w.label.length;C++)D=jQuery("<div/>",{class:"jm_station__label"}),void 0!==w.label[C].left&&D.css("left",w.label[C].left*s),void 0!==w.label[C].top&&D.css("top",w.label[C].top*s),w.label[C].class&&D.addClass(w.label[C].class),y+=D[0].outerHTML;if(x.html('<p class="jm_station__name">'+(void 0!==w.display_name?w.display_name:w.name)+"</p>"+y),void 0!==w.text_align)switch(w.text_align){case 0:x.children(".jm_station__name").css("text-align","left");break;case 1:x.children(".jm_station__name").css("text-align","center");break;case 2:x.children(".jm_station__name").css("text-align","right")}void 0!==w.clone&&x.append('<p class="jm_clone" style="top:'+w.clone.top*s+"px; left:"+w.clone.left*s+'px;">'+w.name+"</p>"),z&&z.detail&&x.append('<div class="jm_info"><div class="jm_info__content">'+z.detail+'</div><div class="jm_info__triangle"><div class="jm_info__triangle-inner"></div></div></div>'),i+=x[0].outerHTML,k.push({id:w.id,elem:function(){return a("#jm_"+r+"_station_"+this.id)},left:B.left,top:B.top,width:B.left+B.width,height:B.top+B.height,name:w.name,nameLowerCase:w.name.toLowerCase()}),window.$stations=k}i+="</div></div>",f.data("jmetroid",r).addClass("jmetro").toggleClass("editable",g.editable).toggleClass("active",v).toggleClass("no-blur",!g.blur).toggleClass("show-info",g.show_info).toggleClass("ie-fix",!!navigator.userAgent.match(/MSIE|Trident/)).html(i);for(var E,t=k.length;t--;)E=k[t],E.elem=E.elem(),E.elemName=E.elem.children("p"),E.elem.data("jm_station_id",E.id),l[E.id]=E;if(o=[],p=f.find(".jm_select2"),g.search_and_input&&a.fn.select2&&Array.prototype.map){var F=k.map(function(a){return{id:a.id,text:a.name}});p.select2({formatResult:function(a){return a.text},width:"100%",query:function(a){var b,c;""===a.term?(o.length&&(e("",o),o=[]),c=F):(b=e(a.term,o,k),c=b.select2Results.reverse().sort(function(a,b){return("<"===b.text[0]?1:0)-("<"===a.text[0]?1:0)}),o=b.arSearch),a.callback({results:c})},initSelection:function(a,b){var c=a.val();if(!c)return b([]);var d=[];c.split(",").forEach(function(a){var b=a&&l[a]&&l[a].name;b&&d.push({id:a,text:b})}),b(d)},multiple:!0}),p.on("change",function(a){console.error("CHANGE",a.added,a.removed),a.added&&l[a.added.id].elem.click(),a.removed&&l[a.removed.id].elem.click()}),g._debug&&(window.jSelect2=p),q=!0}if(v){var G=Object.keys(j);q&&p.select2("val",G),f.val(G)}else f.val([]);!g._edit&&g.editable&&f.on("click","div.jm_station",function(b,c){var d=a(this),e=d.data("jm_station_id");if(d.hasClass("disabled"))return!1;d.toggleClass("selected"),d.hasClass("selected")&&(!g.limit||++n<=g.limit)?j[e]=1:(d.removeClass("selected selected_by_frame"),g.limit&&n--,delete j[e]),f.toggleClass("active",!a.isEmptyObject(j));var h=Object.keys(j);return q&&p.select2("val",h),f.val(h),void 0===c&&f.trigger("change.jmetro"),!1}),f.on("mousedown click",".jm_info__content",function(a){a.stopPropagation()}),g.search_and_input&&f.on("keyup",".jm_search>input",function(){var b=a(this).val(),c=e(b,o,k);o=c.arSearch,f.toggleClass("active",b||!a.isEmptyObject(j))}),g.clear_button&&f.on("click",".jm_clear",function(){if(!a.isEmptyObject(j)){for(var e,h,b=a(),d=k.length;d--;)e=k[d],h=e.elem,h.hasClass("selected")&&b.push(h[0]);f.removeClass("active"),b.removeClass("selected_by_frame selected"),g.limit&&(n=0),f.trigger("change.jmetro"),j={},f.val([]),q&&p.select2("val",[])}}),g.show_submit&&f.on("click",".jm_submit__button",function(){var b={};b[g.submit_param]=Object.keys(j),location.search=(location.search?location.search+"&":"?")+a.param(b)});var H,I,J,K,M,N,Q,S,T,A=!1,L={},O=f.find("div.jm_frame"),P=f.children("div.jm_img_block"),R=!1;if(g.editable&&!g.limit&&!g._edit){var E,U,V,X,_,aa;S=function(b){if(A&&R){_=!1,M=b.pageX-H,N=b.pageY-I,M<0&&(L.x=H+M-J,O.css("left",L.x),M=-M),N<0&&(L.y=I+N-K,O.css("top",L.y),N=-N),O.css({width:M,height:N});var c=L.x+M,d=L.y+N;X=a(),V=a();for(var g,e=k.length;e--;)g=k[e],m[g.id]||(U=g.elem,(g.left>L.x&&g.left<c||L.x>g.left&&L.x<g.width)&&(g.top>L.y&&g.top<d||L.y>g.top&&L.y<g.height)?U.hasClass("selected")||(X.push(U[0]),j[g.id]=1):U.hasClass("selected_by_frame")&&(V.push(U[0]),delete j[g.id]));V.length&&(V.removeClass("selected_by_frame selected"),_=!0),X.length&&(X.addClass("selected selected_by_frame"),_=!0),_&&(f.toggleClass("active",!a.isEmptyObject(j)),aa=!0)}},T=function(b){if(clearTimeout(Q),R=!1,O.removeAttr("style"),aa&&A){var c=Object.keys(j);q&&p.select2("val",c),f.val(c),f.trigger("change.jmetro")}A=!1,f.toggleClass("active",!a.isEmptyObject(j)),a(window).off("mousemove",S),a(window).off("mouseup",T)},f.on("mousedown",".jm_img_block",function(b){return A=!0,aa=!1,H=b.pageX,I=b.pageY,J=P.offset().left,K=P.offset().top,L.x=H-J,L.y=I-K,O.css({left:L.x,top:L.y}),Q=setTimeout(function(){R=!0},120),a(window).on("mousemove",S),a(window).on("mouseup",T),!1})}if(g._edit){var ba,ca,da,ea,fa,ga,ha,ia,ja=!1;editingStart=!1,defaultLabelCssTop=-4,defaultLabelCssLeft=-16,f.data("station_src_backup",a.extend(!0,[],g.stations_src)),f.removeClass("active"),f.on("mousedown",".jm_img_block",function(b){ja=!1;var c=a(b.target).closest(".jm_station").data("jm_station_id");ia=g.stations_src.find(function(a){return a.id===c}),a(b.target).hasClass("jm_station__label")?(ja=!0,ha=a(b.target)):ha=a(b.target).closest(".jm_station"),ba=b.pageX,ca=b.pageY,fa=parseInt(ha.css("left")),ga=parseInt(ha.css("top")),console.log(c,ia,ha[0]),editingStart=!0}),f.mousemove(function(a){editingStart&&(da=a.pageX-ba,ea=a.pageY-ca,ha.css({left:fa+da+"px",top:ga+ea+"px"}))}),f.mouseup(function(a){editingStart&&(editingStart=!1)})}f.data("stations",k),g._debug&&(console.log("jmetro loaded!"),console.log(c))})},_getStationsSrcJson:function(){var b=[],c=1e6;return stationSrc=$this.data("station_src_backup"),a(this).find(".jm_imgmap .jm_station").each(function(d,e){var f=a(e),g={id:f.data("jm_station_id")?f.data("jm_station_id"):function(a){var b=c++;return a.data("jm_station_id",b),b}(f),name:f.children(".jm_station__name").text(),top:parseInt(f.css("top")),left:parseInt(f.css("left")),height:parseInt(f.css("height")),width:parseInt(f.css("width")),label:[]},h=stationSrc.find(function(a){return a.id===g.id});h&&void 0!==h.class&&(g.class=h.class),h&&void 0!==h.display_name&&(g.class=h.display_name);var i=f.children(".jm_station__name")[0].style.textAlign;switch(i){case"left":g.text_align=0;break;case"center":g.text_align=1;break;case"right":g.text_align=2}if(f.children(".jm_station__label").each(function(a,b){if(""===b.style.top&&""===b.style.left)g.label.push(1);else{var c={};""!=b.style.top&&(c.top=parseInt(b.style.top)),""!=b.style.left&&(c.left=parseInt(b.style.left)),g.label.push(c)}}),f.children(".jm_clone").length){var k=f.children(".jm_clone")[0],l={};""!=k.style.top&&(l.top=parseInt(k.style.top)),""!=k.style.left&&(l.left=parseInt(k.style.left)),g.clone=l}b.push(g)}),b},destroy:function(){return this.each(function(){var b=a(this),c=b.data("tooltip");a(window).unbind(".tooltip"),c.tooltip.remove(),b.removeData("tooltip")})},set_value:function(b){if(!b)return"arr is not defined";var c=a(this),d=c.data("stations");if(c.children(".jm_metro_selected").length)var e=!0;else var e=!1;for(var l,m,f=!1,g="",h=a(),i="",j=a(),k=d.length;k--;)l=d[k],m=l.elem,b.indexOf(l.id)!==-1?m.hasClass("selected")||(h.push(m[0]),e&&(g+="#selected_"+l.id+",")):m.hasClass("selected")&&(j.push(m[0]),e&&(i+="#selected_"+l.id+","));j.length&&(e&&c.find(i.slice(0,-1)).removeClass("visiable"),j.removeClass("selected_by_frame selected"),f=!0),h.length&&(e&&c.find(g.slice(0,-1)).addClass("visiable"),h.addClass("selected selected_by_frame"),f=!0),f&&(c.find("div.jm_station").is(".selected")?c.toggleClass("active",!0):c.toggleClass("active",!1))},hide:function(){},update:function(a){}},e=function(a,b,c){var d,g,e=a.toLowerCase(),f=[];for(d=b.length;d--;)b[d].elem.removeClass("searchable"),b[d].elemName[0].innerHTML=b[d].name;if(b=[],a)for(d=c.length,g;d--;)g=c[d],~g.nameLowerCase.indexOf(e)&&(b.push(g),g.elem.addClass("searchable"),f.push({id:g.id,text:g.elemName[0].innerHTML=g.name.replace(new RegExp(e,"ig"),'<span style="color: red;">$&</span>')}));return{select2Results:f,arSearch:b}};a.fn.jmetro=function(b){return d[b]?d[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error('Method with name: "'+b+'" does not exist for jMetro'):d.init.apply(this,arguments)}}(jQuery);